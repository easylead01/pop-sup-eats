
document.addEventListener('DOMContentLoaded', () => {

    const svgCreator = (element, one, two) => {

        let svg = element.children[0];
        let use = svg.children[0];


        //
        //
        // xlink:href /images/sprite/symbol/sprite.svg#heart2
        //
        // class svg-sprite-icon icon-heart2

        // let svg  = document.createElement('svg');
        //
        // let use  = document.createElement('use');
        //
        element.classList.toggle('active');


        if (element.classList.contains('active')) {

            svg.setAttribute('class', 'svg-sprite-icon icon-'+two);

            use.setAttribute('xlink:href', '/images/sprite/symbol/sprite.svg#'+two);
        }else{
            svg.setAttribute('class', 'svg-sprite-icon icon-'+one);

            use.setAttribute('xlink:href', '/images/sprite/symbol/sprite.svg#'+one);
        }


    };


    // var outSvg = function outSvg(myElems, nameSvg, nameSvgActive) {
    //   var elems = document.querySelectorAll(myElems);
    //   elems.forEach(function (el) {
    //     el.addEventListener('click', function (e) {
    //       e.preventDefault();
    //       el.classList.toggle('active');
    //
    //       if (el.classList.contains('active')) {
    //         el.innerHTML = "\n\t\t\t\t\t<svg class=\"svg-sprite-icon icon-".concat(nameSvgActive, "\">\n\t\t\t\t\t\t<use xlink:href=\"/images/sprite/symbol/sprite.svg#").concat(nameSvgActive, "\"></use>\n\t\t\t\t\t</svg>\n\t\t\t\t\t");
    //       } else {
    //         el.innerHTML = "\n\t\t\t\t\t<svg class=\"svg-sprite-icon icon-".concat(nameSvg, "\">\n\t\t\t\t\t\t<use xlink:href=\"/images/sprite/symbol/sprite.svg#").concat(nameSvg, "\"></use>\n\t\t\t\t\t</svg>\n\t\t\t\t\t");
    //       }
    //     });
    //   });
    // };
    //
    // outSvg('.cards__item-top-el2', 'heart2', '2');
    // outSvg('.cards__item-top-el1', 'rat2', 'rat');



    //
    // let goodId = document.querySelectorAll('[data-good-id]');
    //
    // goodId.forEach(el => {
    //     el.addEventListener('click', event =>{
    //         console.log(event.target);
    //         console.log(event.target.closest('.cards__item-top-el2'));
    //         console.log(event.target.parentElement);
    //     })
    // })



    const cartHendler = element => {


        let quantity = element.parentElement.parentElement.querySelector('.cards__int');

        if (!quantity){
            quantity = element.parentElement.parentElement.querySelector('.cards__int2');
        }

        let formData = new FormData();
        formData.append('id', element.dataset.goodId);
        formData.append('type', element.dataset.goodType);
        formData.append('quantity', quantity.value);
        formData.append('type_action', "cart");



        if (element.dataset.cart==="add"){

            formData.append('action', 'add');

            _helper.fetch('/submit/cart',formData,
                response => {
                    response.json()
                        .then(json => {
                            document.querySelector('.header__top-comparison-products-el .count-cart').innerHTML = json.count;
                            document.querySelector('.header__top-products-wrap .rub').setAttribute('data-txt', json.totalPriceDiscount);
                            document.querySelector('.header__top-products-wrap .rub').setAttribute('data-txt2', "В корзине "+json.totalPriceDiscount);
                        })

                },
                response => {
                    console.log(response);
                    alert("что то пошло не так");
                });

        } else{
            formData.append('action', 'remove');
        }
    };

    const favoritHendler = element => {

        let formData = new FormData();

        formData.append('id', element.dataset.goodId);
        formData.append('type', element.dataset.goodType);
        formData.append('type_action', "favorit");


        if (element.dataset.favorit==="add"){

            formData.append('action', 'add');

            _helper.fetch('/submit/favorit',formData,
                response => {
                    response.json()
                        .then(json => {

                            document.querySelector('.header__top-heart-comparison .count-favorit').innerHTML = json.count;

                            svgCreator(element,'heart2', '2');

                        })

                },
                response => {
                    alert("что то пошло не так");
                });

        }else{
            formData.append('action', 'remove');

            _helper.fetch('/submit/favorit',formData,
                response => {
                    response.json()
                        .then(json => {
                            document.querySelector('.header__top-heart-comparison .count-favorit').innerHTML = json.count;
                            svgCreator(element,'heart2', '2');
                        })

                },
                response => {
                    alert("что то пошло не так");
                });

        }
    };

    const compareHendler = element => {

        let formData =new FormData();

        formData.append('id', element.dataset.goodId);
        formData.append('type', element.dataset.goodType);


        if (element.dataset.compare==="add"){
            formData.append('action', 'add');

            _helper.fetch('/submit/compare',formData,
                response => {
                    response.json()
                        .then(json => {
                            document.querySelector('.header__top-comparison .count-compare').innerHTML = json.count;
                            svgCreator(element,'rat2', 'rat');
                        })
                },
                response => {
                    alert("что то пошло не так");
                });

        }else{

            formData.append('action', 'remove');

            _helper.fetch('/submit/compare',formData,
                response => {
                    response.json()
                        .then(json => {
                            document.querySelector('.header__top-heart-comparison .count-favorit').innerHTML = json.count;
                            svgCreator(element,'rat2', 'rat');
                        })

                },
                response => {
                    alert("что то пошло не так");
                });
        }
    };

    const lessHendler = element => {

        let counter = element.parentElement.querySelector('.cards__int');

        if (!counter){
            counter = element.parentElement.querySelector('.cards__int2');
        }
        
        if (counter.value > 1){
            counter.value--;
        }
    };

    const moreHendler = element => {

        let counter = element.parentElement.querySelector('.cards__int');

        if (!counter){
            counter = element.parentElement.querySelector('.cards__int2');
        }

        counter.value++;
    };



    const checkDatasets = element => {
        let i = 0;
        for(let el in element){
            i++;
        }
        if (i===0){
            return false;
        }
        return true;
    };

    const cardsContainers = document.querySelector('.cards');


    cardsContainers.addEventListener('click', event => {
            // event.preventDefault();

            let target = event.target;

            if (!checkDatasets(target.dataset)){
                target = target.closest('[data-good-id]');
            }

            if (target.dataset.cart){
                cartHendler(target);
            }else if (target.dataset.favorit){
                event.preventDefault();
                favoritHendler(target);

            }else if (target.dataset.compare){
                event.preventDefault();
                compareHendler(target);

            }else if (target.dataset.less){
                event.preventDefault();
                lessHendler(target);

            }else if (target.dataset.more){
                event.preventDefault();
                moreHendler(target);
            }
        });
});